<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tải Video TikTok - Không Watermark & Nhiều Video</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #69C9D0;
            --secondary: #EE1D52;
            --dark: #121826;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a1f35 0%, #0d1117 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        /* HEADER */
        header {
            text-align: center;
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }
        header h1 {
            font-size: clamp(2rem, 5vw, 3.2rem);
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
        .tagline {
            color: var(--gray);
            font-size: clamp(1rem, 3vw, 1.2rem);
            margin-bottom: 25px;
        }
        /* MAIN INPUT */
        .main-input {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            resize: vertical;
        }
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        .buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        button {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
        }
        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(105, 201, 208, 0.3);
        }
        button:active {
            transform: translateY(-1px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        .hint {
            color: var(--gray);
            font-size: 0.95rem;
            margin-top: 15px;
            text-align: center;
        }
        /* RESULTS */
        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .video-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }
        .video-card:hover {
            transform: translateY(-5px);
        }
        .video-preview {
            width: 100%;
            aspect-ratio: 9/16;
            background: #000;
            position: relative;
        }
        .video-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-info {
            padding: 20px;
        }
        .video-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: var(--gray);
        }
        .video-desc {
            margin-bottom: 20px;
            font-size: 0.95rem;
            line-height: 1.5;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .video-actions {
            display: flex;
            gap: 10px;
        }
        .video-actions a, .video-actions button {
            flex: 1;
            padding: 12px;
            font-size: 0.95rem;
            border-radius: 8px;
        }
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        /* STATUS */
        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            max-width: 400px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        .status.hidden {
            display: none;
        }
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .status-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .status-close {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            min-width: auto;
        }
        .progress-container {
            margin-bottom: 15px;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }
        .status-details {
            font-size: 0.9rem;
            color: var(--gray);
        }
        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* FOOTER */
        footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--gray);
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 40px;
        }
        .disclaimer {
            max-width: 800px;
            margin: 20px auto;
            padding: 15px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 10px;
            font-size: 0.85rem;
        }
        /* RESPONSIVE */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .main-input {
                padding: 20px;
            }
            button {
                min-width: 100%;
            }
            .results-container {
                grid-template-columns: 1fr;
            }
            .status {
                left: 10px;
                right: 10px;
                max-width: none;
                bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fab fa-tiktok"></i> TikTok Downloader Pro</h1>
            <p class="tagline">Tải video TikTok không watermark, hỗ trợ nhiều video cùng lúc</p>
        </header>

        <main>
            <div class="main-input">
                <div class="input-group">
                    <textarea id="urlInput" placeholder="Dán link video TikTok vào đây (mỗi link trên 1 dòng hoặc cách nhau bằng dấu cách):
                    
Ví dụ:
https://vm.tiktok.com/ZSY5gRqNf/
https://www.tiktok.com/@user/video/123456789
https://vt.tiktok.com/ABC123/"></textarea>
                    
                    <div class="buttons">
                        <button id="downloadBtn" class="btn-primary">
                            <i class="fas fa-download"></i> Tải Video Hàng Loạt
                        </button>
                        <button id="clearBtn" class="btn-secondary">
                            <i class="fas fa-trash"></i> Xóa Tất Cả
                        </button>
                    </div>
                </div>
                
                <p class="hint">
                    <i class="fas fa-lightbulb"></i> Hệ thống tự động thử nhiều API (Tikmate, SnapTik, v.v.) để tải video. Bạn có thể dán tối đa 10 link cùng lúc.
                </p>
            </div>

            <div id="resultsSection">
                <!-- Kết quả sẽ hiển thị ở đây -->
            </div>
        </main>

        <!-- Status Panel -->
        <div id="statusPanel" class="status hidden">
            <div class="status-header">
                <div class="status-title">
                    <i class="fas fa-sync-alt"></i> Đang xử lý
                </div>
                <button class="status-close" onclick="hideStatus()">×</button>
            </div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </div>
            <div class="status-details">
                <div id="statusText">Đang khởi tạo...</div>
                <div id="apiStatus">API đang dùng: Đang kiểm tra...</div>
            </div>
        </div>

        <footer>
            <div class="disclaimer">
                <strong><i class="fas fa-exclamation-triangle"></i> Lưu ý:</strong> Công cụ này chỉ dành cho mục đích cá nhân. Hãy tôn trọng bản quyền và quyền riêng tư của người sáng tạo nội dung. TikTok là nhãn hiệu đã đăng ký của ByteDance Ltd.
            </div>
            <p>Hệ thống đa API | Tối ưu cho điện thoại | Hoạt động trên GitHub Pages</p>
        </footer>
    </div>

    <script>
        // ====================== CẤU HÌNH HỆ THỐNG API ======================
        const API_PROVIDERS = [
            {
                name: "Tikmate.io",
                url: "https://api.tikmate.app/api/lookup",
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                processData: async (url, provider) => {
                    const formData = new URLSearchParams();
                    formData.append("url", url);
                    
                    const response = await fetch(provider.url, {
                        method: provider.method,
                        headers: provider.headers,
                        body: formData
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    console.log("Tikmate response:", data);
                    
                    // Tikmate trả về video_url trong response
                    if (data.video_url) {
                        return {
                            videoUrl: data.video_url,
                            author: data.author_name || "Không rõ",
                            description: data.description || "Không có mô tả"
                        };
                    }
                    throw new Error("Không tìm thấy video_url");
                }
            },
            {
                name: "SnapTik API",
                url: "https://snaptik.app/action.php",
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                processData: async (url, provider) => {
                    const formData = new URLSearchParams();
                    formData.append("url", url);
                    formData.append("lang", "vi");
                    
                    const response = await fetch(provider.url, {
                        method: provider.method,
                        headers: provider.headers,
                        body: formData
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const text = await response.text();
                    console.log("SnapTik response text:", text.substring(0, 200));
                    
                    // SnapTik thường trả về HTML chứa iframe hoặc link tải
                    // Đây là cách đơn giản, bạn có thể cần điều chỉnh dựa trên response thực tế
                    const match = text.match(/href="([^"]*\.mp4)"/i);
                    if (match && match[1]) {
                        return {
                            videoUrl: match[1],
                            author: "SnapTik",
                            description: "Video từ SnapTik"
                        };
                    }
                    throw new Error("Không tìm thấy link MP4 trong response");
                }
            },
            {
                name: "API Dự phòng 1",
                url: "https://tikdown.org/api/ajaxSearch",
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                processData: async (url, provider) => {
                    const formData = new URLSearchParams();
                    formData.append("query", url);
                    
                    const response = await fetch(provider.url, {
                        method: provider.method,
                        headers: provider.headers,
                        body: formData
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    console.log("Backup API 1 response:", data);
                    
                    if (data.data && data.data.video) {
                        return {
                            videoUrl: data.data.video,
                            author: data.data.author || "Không rõ",
                            description: data.data.title || "Không có mô tả"
                        };
                    }
                    throw new Error("Không tìm thấy video trong response");
                }
            }
        ];

        // ====================== BIẾN TOÀN CỤC ======================
        let currentDownloads = [];
        let activeProviderIndex = 0;

        // ====================== HÀM TIỆN ÍCH ======================
        function showStatus(message, apiName = "", progress = 0) {
            const panel = document.getElementById("statusPanel");
            const statusText = document.getElementById("statusText");
            const apiStatus = document.getElementById("apiStatus");
            const progressFill = document.getElementById("progressFill");
            
            statusText.textContent = message;
            apiStatus.textContent = apiName ? `API đang dùng: ${apiName}` : "";
            progressFill.style.width = `${progress}%`;
            
            panel.classList.remove("hidden");
        }

        function hideStatus() {
            document.getElementById("statusPanel").classList.add("hidden");
        }

        function updateProgress(current, total) {
            const percent = total > 0 ? Math.round((current / total) * 100) : 0;
            document.getElementById("progressFill").style.width = `${percent}%`;
            return percent;
        }

        // ====================== XỬ LÝ VIDEO ======================
        async function fetchVideoData(tiktokUrl, retryCount = 0) {
            const maxRetries = API_PROVIDERS.length;
            
            for (let i = 0; i < API_PROVIDERS.length; i++) {
                const providerIndex = (activeProviderIndex + i) % API_PROVIDERS.length;
                const provider = API_PROVIDERS[providerIndex];
                
                showStatus(`Đang thử với ${provider.name}...`, provider.name);
                
                try {
                    console.log(`Thử API ${provider.name} cho URL: ${tiktokUrl}`);
                    const result = await provider.processData(tiktokUrl, provider);
                    
                    // Nếu thành công, cập nhật active provider cho lần sau
                    activeProviderIndex = providerIndex;
                    return {
                        ...result,
                        apiUsed: provider.name,
                        originalUrl: tiktokUrl
                    };
                    
                } catch (error) {
                    console.warn(`API ${provider.name} thất bại:`, error.message);
                    
                    // Nếu đã thử hết tất cả API
                    if (i === API_PROVIDERS.length - 1 && retryCount < maxRetries) {
                        return await fetchVideoData(tiktokUrl, retryCount + 1);
                    }
                }
            }
            
            throw new Error(`Không thể tải video sau ${maxRetries} lần thử`);
        }

        async function processBatchVideoDownload() {
            const urlInput = document.getElementById("urlInput");
            const urls = urlInput.value
                .split(/[\n\s]+/)
                .map(url => url.trim())
                .filter(url => url && isValidTikTokUrl(url))
                .slice(0, 10); // Giới hạn 10 video
            
            if (urls.length === 0) {
                alert("Vui lòng dán ít nhất một link video TikTok hợp lệ.");
                return;
            }
            
            // Tắt nút tải
            const downloadBtn = document.getElementById("downloadBtn");
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
            
            // Hiển thị trạng thái
            showStatus(`Đang xử lý ${urls.length} video...`, "", 0);
            
            // Xóa kết quả cũ
            document.getElementById("resultsSection").innerHTML = '<div class="loading"><div class="spinner"></div><p>Đang tải video...</p></div>';
            
            // Xử lý từng video
            const results = [];
            
            for (let i = 0; i < urls.length; i++) {
                const url = urls[i];
                
                try {
                    // Cập nhật tiến trình
                    const progressPercent = updateProgress(i, urls.length);
                    showStatus(`Đang xử lý video ${i + 1}/${urls.length}...`, `Đang thử API...`, progressPercent);
                    
                    // Lấy dữ liệu video
                    const videoData = await fetchVideoData(url);
                    results.push(videoData);
                    
                    // Hiển thị từng video khi đã xử lý xong
                    displayVideoCard(videoData, i);
                    
                } catch (error) {
                    console.error(`Lỗi với video ${i + 1}:`, error);
                    results.push({
                        error: error.message,
                        originalUrl: url,
                        apiUsed: "None"
                    });
                    
                    // Hiển thị thẻ lỗi
                    displayErrorCard(url, error.message, i);
                }
            }
            
            // Hoàn thành
            showStatus(`Hoàn thành! Đã xử lý ${results.filter(r => !r.error).length}/${urls.length} video`, "", 100);
            
            // Bật lại nút tải
            downloadBtn.disabled = false;
            downloadBtn.innerHTML = '<i class="fas fa-download"></i> Tải Video Hàng Loạt';
            
            // Lưu kết quả vào biến toàn cục
            currentDownloads = results;
            
            // Tự động ẩn status sau 3 giây
            setTimeout(hideStatus, 3000);
        }

        // ====================== HIỂN THỊ KẾT QUẢ ======================
        function displayVideoCard(videoData, index) {
            const resultsSection = document.getElementById("resultsSection");
            
            // Xóa loading nếu là video đầu tiên
            if (index === 0) {
                resultsSection.innerHTML = '<div class="results-container" id="resultsContainer"></div>';
            }
            
            // Đảm bảo container tồn tại
            let container = document.getElementById("resultsContainer");
            if (!container) {
                container = document.createElement("div");
                container.className = "results-container";
                container.id = "resultsContainer";
                resultsSection.appendChild(container);
            }
            
            // Tạo thẻ video
            const card = document.createElement("div");
            card.className = "video-card";
            card.id = `videoCard-${index}`;
            
            card.innerHTML = `
                <div class="video-preview">
                    <video controls>
                        <source src="${videoData.videoUrl}" type="video/mp4">
                        Trình duyệt của bạn không hỗ trợ video tag.
                    </video>
                </div>
                <div class="video-info">
                    <div class="video-meta">
                        <span><i class="fas fa-user"></i> ${videoData.author}</span>
                        <span><i class="fas fa-code-branch"></i> ${videoData.apiUsed}</span>
                    </div>
                    <div class="video-desc" title="${videoData.description}">
                        ${videoData.description}
                    </div>
                    <div class="video-actions">
                        <a href="${videoData.videoUrl}" download="tiktok_${Date.now()}_${index}.mp4" class="btn-success">
                            <i class="fas fa-download"></i> Tải Xuống
                        </a>
                        <button onclick="copyToClipboard('${videoData.videoUrl}', ${index})" class="btn-secondary">
                            <i class="fas fa-copy"></i> Copy Link
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        }

        function displayErrorCard(url, error, index) {
            const resultsSection = document.getElementById("resultsSection");
            
            if (index === 0) {
                resultsSection.innerHTML = '<div class="results-container" id="resultsContainer"></div>';
            }
            
            let container = document.getElementById("resultsContainer");
            if (!container) {
                container = document.createElement("div");
                container.className = "results-container";
                container.id = "resultsContainer";
                resultsSection.appendChild(container);
            }
            
            const card = document.createElement("div");
            card.className = "video-card";
            card.style.borderLeft = "5px solid var(--danger)";
            
            card.innerHTML = `
                <div class="video-info">
                    <div class="video-meta">
                        <span><i class="fas fa-exclamation-triangle"></i> Lỗi</span>
                        <span>Video ${index + 1}</span>
                    </div>
                    <div class="video-desc">
                        <strong>URL:</strong> ${url.substring(0, 50)}...
                    </div>
                    <div style="color: var(--danger); margin: 15px 0; padding: 10px; background: rgba(220, 53, 69, 0.1); border-radius: 8px;">
                        <i class="fas fa-times-circle"></i> ${error}
                    </div>
                    <div class="video-actions">
                        <button onclick="retrySingleVideo('${url}', ${index})" class="btn-primary">
                            <i class="fas fa-redo"></i> Thử Lại
                        </button>
                        <button onclick="removeVideoCard(${index})" class="btn-secondary">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        }

        // ====================== HÀM HỖ TRỢ ======================
        function isValidTikTokUrl(url) {
            const patterns = [
                /https?:\/\/(vm|vt)\.tiktok\.com\/\S+/,
                /https?:\/\/(www\.)?tiktok\.com\/@[\w.-]+\/video\/\d+/,
                /https?:\/\/tiktok\.com\/@[\w.-]+\/video\/\d+/
            ];
            return patterns.some(pattern => pattern.test(url));
        }

        async function retrySingleVideo(url, index) {
            showStatus("Đang thử lại video...");
            
            try {
                const videoData = await fetchVideoData(url);
                
                // Thay thế thẻ lỗi bằng thẻ video
                const container = document.getElementById("resultsContainer");
                const oldCard = document.querySelector(`#resultsContainer .video-card:nth-child(${index + 1})`);
                if (oldCard) {
                    container.removeChild(oldCard);
                }
                
                displayVideoCard(videoData, index);
                showStatus("Thử lại thành công!", "", 100);
                
            } catch (error) {
                showStatus("Thử lại thất bại!", "", 0);
                alert(`Không thể tải lại video: ${error.message}`);
            }
        }

        function removeVideoCard(index) {
            const container = document.getElementById("resultsContainer");
            const card = document.querySelector(`#resultsContainer .video-card:nth-child(${index + 1})`);
            if (card && container) {
                container.removeChild(card);
            }
        }

        function copyToClipboard(text, index) {
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector(`#videoCard-${index} .btn-secondary`);
                if (btn) {
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Đã Copy!';
                    btn.style.background = "var(--success)";
                    
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.style.background = "";
                    }, 2000);
                }
            });
        }

        // ====================== XỬ LÝ SỰ KIỆN ======================
        document.getElementById("downloadBtn").addEventListener("click", processBatchVideoDownload);
        
        document.getElementById("clearBtn").addEventListener("click", function() {
            if (confirm("Bạn có chắc muốn xóa tất cả link và kết quả?")) {
                document.getElementById("urlInput").value = "";
                document.getElementById("resultsSection").innerHTML = "";
                currentDownloads = [];
                hideStatus();
            }
        });

        // Cho phép nhấn Enter trong textarea (nhưng không submit form)
        document.getElementById("urlInput").addEventListener("keydown", function(e) {
            if (e.key === "Enter" && e.ctrlKey) {
                processBatchVideoDownload();
            }
        });

        // Hướng dẫn sử dụng khi trang load
        window.addEventListener("load", function() {
            console.log("TikTok Downloader Pro đã sẵn sàng!");
            console.log(`Hệ thống có ${API_PROVIDERS.length} API dự phòng`);
        });
    </script>
</body>
</html>
